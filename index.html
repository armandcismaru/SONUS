<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>game</title>
	<style>
		html,
		body {
			background: #000;
			width: 100%;
			height: 100%;
			overflow: visible;
			padding: 0;
			margin: 0;
		}

		div#gameContainer {
			background: transparent !important;
			position: absolute;
		}

		div#gameContainer canvas {
			position: absolute;
		}

		div#gameContainer canvas[data-pixel-art="true"] {
			position: absolute;
			image-rendering: optimizeSpeed;
			image-rendering: -webkit-crisp-edges;
			image-rendering: -moz-crisp-edges;
			image-rendering: -o-crisp-edges;
			image-rendering: crisp-edges;
			image-rendering: -webkit-optimize-contrast;
			image-rendering: optimize-contrast;
			image-rendering: pixelated;
			-ms-interpolation-mode: nearest-neighbor;
		}
	</style>
</head>

<body>
	<div id="gameContainer">
		<canvas id="unity-canvas" data-pixel-art=""></canvas>
		<script src="Build/WebGL.loader.js"></script>
		<script>
			var canvas = document.querySelector("#unity-canvas");
			var config = {
				dataUrl: "Build/WebGL.data",
				frameworkUrl: "Build/WebGL.framework.js",
				codeUrl: "Build/WebGL.wasm",
				streamingAssetsUrl: "StreamingAssets",
				companyName: "DefaultCompany",
				productName: "game",
				productVersion: "0.0.103",
			};
			var scaleToFit;
			try {
				scaleToFit = !!JSON.parse("true");
			} catch (e) {
				scaleToFit = true;
			}
			function progressHandler(progress) {
				var percent = progress * 100 + '%';
				canvas.style.background = 'linear-gradient(to right, white, white ' + percent + ', transparent ' + percent + ', transparent) no-repeat center';
				canvas.style.backgroundSize = '100% 1rem';
			}
			function onResize() {
				var container = canvas.parentElement;
				var w;
				var h;

				if (scaleToFit) {
					w = window.innerWidth;
					h = window.innerHeight;

					var r = 600 / 960;

					if (w * r > window.innerHeight) {
						w = Math.min(w, Math.ceil(h / r));
					}
					h = Math.floor(w * r);
				} else {
					w = 960;
					h = 600;
				}

				container.style.width = canvas.style.width = w + "px";
				container.style.height = canvas.style.height = h + "px";
				container.style.top = Math.floor((window.innerHeight - h) / 2) + "px";
				container.style.left = Math.floor((window.innerWidth - w) / 2) + "px";
			}
			createUnityInstance(canvas, config, progressHandler).then(function (instance) {
        window.unityInstance = instance;
				canvas = instance.Module.canvas;
				onResize();
			});
			window.addEventListener('resize', onResize);
			onResize();
		</script>
	</div>



    <div class="audios">
      <audio id="audio0"></audio>
      <audio id="audio1"></audio>
      <audio id="audio2"></audio>
      <audio id="audio2"></audio>
      <audio id="audio3"></audio>
      <audio id="audio4"></audio>
      <audio id="audio5"></audio>
    </div>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    
    <script>
      navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

      const audios = [
            document.getElementById("audio0"),
            document.getElementById("audio1"),
            document.getElementById("audio2"),
            document.getElementById("audio3"),
            document.getElementById("audio4"),
            document.getElementById("audio5")];

      let remoteStream = [new MediaStream(),
                  new MediaStream(),
                  new MediaStream(),
                  new MediaStream(),
                  new MediaStream(),
                  new MediaStream()];

      let connections = [null, null, null, null, null, null];

      let conf = {
        secure : true,
        host: 'sonus-server.herokuapp.com',
        config:{"iceServers" :[
                  {
                    urls: "stun:l.google.com:19302"
                  },
                  {
                    urls: "turn:34.140.207.2:3478",
                    username: "sonus",
                    credential: "sonus12345"
                  }]}
      };

      let peers = [new Peer(conf), 
                  new Peer(conf),
                  new Peer(conf),
                  new Peer(conf),
                  new Peer(conf),
                  new Peer(conf)];
        
      let panner = [null, null, null, null, null, null];
      let gain = [null, null, null, null, null, null];

      let localStream = null;

      const pannerSettings = {
            panningModel:      'HRTF',
            distanceModel:     'linear',
            refDistance:       1,
            maxDistance:       300,
            rolloffFactor:     1,
            coneInnerAngle:    360,
            coneOuterAngle:    0,
            coneOuterGain:     0
      };

      let aContext = new AudioContext();
      aContext.listener.setPosition(0, 0, 0);
      
      window.setPlayerPosition = function(index, x, y, z){
        //console.log("ind %d, %f %f %f", index, x, y, z);
        if(panner[index] != null){
          panner[index].setPosition(x, y, z);
        }
      }

      window.setOrientation = function(x, y, z){
        aContext.listener.setOrientation(x, y, z, 0, 1, 0);
        //aContext.listener.forwardX.value = x;
        //aContext.listener.forwardY.value = y;
        //aContext.listener.forwardZ.value = z;
      }

      window.setGainValue = function(index, value){
        if(gain[index] != null){
          console.log("setting index %d to value %d", index, value);
          gain[index].gain.setValueAtTime(value, aContext.currentTime);
        }
      }

      window.returnIds = function() {
        let ids = peers[0].id
        for(let i = 1; i < peers.length; i++){
            ids = ids.concat(",", peers[i].id);
        }
        return ids;
      }

      window.initialize = async function() {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true});

        peers[0].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });
  
        peers[1].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });
  
        peers[2].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });
  
        peers[3].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });
  
        peers[4].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });
  
        peers[5].on('error', function(err) { 
          console.log("error on peerjs")
          console.log(err)
        });

        peers[0].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[0] = aContext.createPanner(pannerSettings);
            gain[0] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[0]).connect(panner[0]).connect(aContext.destination);
            audios[0].srcObject = stream;
          }); 
        });

        peers[1].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[1] = aContext.createPanner(pannerSettings);
            gain[1] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[1]).connect(panner[1]).connect(aContext.destination);
            audios[1].srcObject = stream;
          }); 
        });
        
        peers[2].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[2] = aContext.createPanner(pannerSettings);
            gain[2] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[2]).connect(panner[2]).connect(aContext.destination);
            console.log(stream.getTracks().length);
            audios[2].srcObject = stream;
          }); 
        });

        peers[3].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[3] = aContext.createPanner(pannerSettings);
            gain[3] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[3]).connect(panner[3]).connect(aContext.destination);
            console.log(stream.getTracks().length);
            audios[3].srcObject = stream;
          }); 
        });

        peers[4].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[4] = aContext.createPanner(pannerSettings);
            gain[4] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[4]).connect(panner[4]).connect(aContext.destination);
            console.log(stream.getTracks().length);
            audios[4].srcObject = stream;
          }); 
        });

        peers[5].on('call', function(mediaConnection) {
          mediaConnection.answer(localStream);
          mediaConnection.on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[5] = aContext.createPanner(pannerSettings);
            gain[5] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[5]).connect(panner[5]).connect(aContext.destination);
            console.log(stream.getTracks().length);
            audios[5].srcObject = stream;
          }); 
        });
        
      }

      window.createCall = function(index, id) {
        console.log("index is ");
        console.log(index);
        if(localStream != null){
          connections[index] = peers[index].call(id, localStream);
          connections[index].on('stream', function(stream) {
            if (aContext.state === 'suspended') {
              aContext.resume();
            }
            panner[index] = aContext.createPanner(pannerSettings);
            gain[index] = aContext.createGain();
            const source = aContext.createMediaStreamSource(stream);
            source.connect(gain[index]).connect(panner[index]).connect(aContext.destination);
            aContext.listener.setPosition(0, 0, 0);
            audios[index].srcObject = stream;
          });  
        }
      }

    
    </script>
    <script src="js/mainScript.js"></script>
    <!-- These are the two JavaScript files you must load in the HTML,
    The recognizer is loaded through a Web Worker -->
    <script src="js/audioRecorder.js"></script>
    <script src="js/callbackManager.js"></script>

  </body>
</html>
